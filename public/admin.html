<!-- --- START OF FILE admin.html --- -->

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AGENCY ADMIN</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #000500; padding: 20px; font-family: 'Share Tech Mono'; }
        .admin-box { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #00ff41; padding-bottom: 10px; margin-bottom: 20px; }
        .title { color: #00ff41; font-family: 'Orbitron'; font-size: 1.5rem; text-shadow: 0 0 10px #00ff41; }
        .my-wallet { background: rgba(0, 255, 65, 0.05); border: 1px solid #00ff41; padding: 20px; margin-bottom: 20px; text-align: center; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        .wallet-amount { font-family: 'Orbitron'; font-size: 2.5rem; color: #fff; text-shadow: 0 0 15px #00ff41; margin: 10px 0; }
        .wallet-label { color: #00ff41; font-size: 0.9rem; letter-spacing: 2px; }
        .panel { background: #051005; border: 1px solid #00ff41; padding: 20px; margin-bottom: 20px; }
        input { background: #000; border: 1px solid #444; color: #fff; padding: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: #00ff41; box-shadow: 0 0 5px #00ff41; }
        .search-bar { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .search-input { width: 100%; border: 1px solid #333; padding: 12px; font-family: 'Share Tech Mono'; color: #00ff41; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .card { background: #111; border: 1px solid #333; padding: 15px; position: relative; transition: 0.3s; }
        .card:hover { border-color: #00ff41; transform: translateY(-2px); }
        .tk-box { color: #00ff41; font-size: 1.2rem; margin: 10px 0; font-family: 'Orbitron'; }
        button { cursor: pointer; font-family: 'Orbitron'; font-weight: bold; padding: 5px 10px; border: none; margin-left:2px; }
        .btn-add-main { background: #00ff41; color: #000; padding: 10px 20px; }
        .btn-nap { background:#00ff41; color:#000; }
        .btn-rut { background:#ff9800; color:#000; }
        .btn-xoa { background:#333; color:#f00; border:1px solid #555; }
        /* C·∫≠p nh·∫≠t style n√∫t Excel */
        .btn-excel { background:#003b0f; color:#fff; border:1px solid #00ff41; padding:10px; white-space:nowrap; }
        .btn-excel:hover { background:#00ff41; color:#000; }
    </style>
</head>
<body>
    <div class="admin-box">
        <div class="header">
            <div class="title">AGENCY PANEL (ƒê·∫†I L√ù)</div>
            <button onclick="logout()" style="background:#333; color:#fff; padding:10px;">ƒêƒÇNG XU·∫§T</button>
        </div>

        <div class="my-wallet">
            <div class="wallet-label">KHO TOKEN C·ª¶A B·∫†N</div>
            <div id="myBalance" class="wallet-amount">Loading...</div>
            <div style="font-size: 0.8rem; color: #888;">(Li√™n h·ªá Super Admin ƒë·ªÉ nh·∫≠p th√™m h√†ng)</div>
        </div>

        <div class="panel">
            <h3 style="color:#fff; margin-top:0;">‚ûï TH√äM KH√ÅCH V√ÄO QU·∫¢N L√ù</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="targetUser" placeholder="T√™n User..." style="width:250px;" maxlength="20">
                <button onclick="importUser()" class="btn-add-main">K√çCH HO·∫†T</button>
            </div>
            <p style="color:#666; font-size:0.8rem;">* Nh·∫≠p t√™n User ƒë√£ ƒëƒÉng k√Ω ƒë·ªÉ qu·∫£n l√Ω h·ªç.</p>
        </div>

        <h3 style="color:#fff; margin-bottom: 10px;">DANH S√ÅCH KH√ÅCH H√ÄNG</h3>
        
        <div class="search-bar">
            <span style="color:#00ff41;">üîç</span>
            <input type="text" id="searchInput" class="search-input" 
                   placeholder="T√¨m ki·∫øm kh√°ch h√†ng (nh·∫≠p t√™n)..." 
                   maxlength="20"
                   onkeyup="filterUsers()">
            
            <!-- C·∫¨P NH·∫¨T: N√öT XU·∫§T EXCEL -->
            <button onclick="exportExcel()" class="btn-excel">
                üì• XU·∫§T EXCEL
            </button>
        </div>

        <div id="grid" class="grid">Loading...</div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        if (!token || role !== 'admin') window.location.href = 'login.html';

        async function loadMyBalance() {
            try {
                const res = await fetch('/api/me', { headers: { 'Authorization': token } });
                const me = await res.json();
                if (me.username) {
                    document.getElementById('myBalance').innerText = Math.floor(me.tokens).toLocaleString('vi-VN');
                }
            } catch(e) { console.error(e); }
        }

        async function loadData() {
            loadMyBalance();
            const res = await fetch('/api/users', { headers: { 'Authorization': token } });
            const list = await res.json();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            if(list.length === 0) {
                grid.innerHTML = '<div style="color:#666;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o.</div>';
                return;
            }

            list.forEach(u => {
                const displayToken = Math.floor(u.tokens).toLocaleString('vi-VN');
                // C·∫¨P NH·∫¨T: Hi·ªÉn th·ªã phone
                const phoneDisplay = u.phone ? u.phone : 'Ch∆∞a c·∫≠p nh·∫≠t';

                grid.innerHTML += `
                    <div class="card user-item">
                        <div style="display:flex; justify-content:space-between; color:#fff; font-size:1.1rem;">
                            <span class="username-text">${u.username}</span>
                            <span style="border:1px solid #00ff41; color:#00ff41; padding:2px 5px; font-size:0.7rem;">MEMBER</span>
                        </div>
                        
                        <!-- C·∫¨P NH·∫¨T: D√íNG HI·ªÇN TH·ªä SƒêT -->
                        <div style="color:#aaa; font-size:0.9rem; margin-top:8px; padding-bottom:5px; border-bottom:1px dashed #333;">
                            üìû SƒêT: <span style="color:#fff; font-weight:bold;">${phoneDisplay}</span>
                        </div>

                        <div class="tk-box">KH√ÅCH C√íN: ${displayToken}</div>
                        
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input type="number" id="amt-${u._id}" placeholder="SL" 
                                   style="width:70px; padding:5px;"
                                   oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20);">
                            
                            <button onclick="modifyToken('${u._id}', 'add')" class="btn-nap">N·∫†P</button>
                            <button onclick="modifyToken('${u._id}', 'revoke')" class="btn-rut">THU H·ªíI</button>
                            <button onclick="delUser('${u._id}')" class="btn-xoa">X√ìA</button>
                        </div>
                    </div>
                `;
            });
            
            filterUsers();
        }

        function filterUsers() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const cards = document.getElementsByClassName('user-item');

            for (let i = 0; i < cards.length; i++) {
                const nameSpan = cards[i].getElementsByClassName('username-text')[0];
                const txtValue = nameSpan.textContent || nameSpan.innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    cards[i].style.display = "";
                } else {
                    cards[i].style.display = "none";
                }
            }
        }

        // C·∫¨P NH·∫¨T: H√ÄM XU·∫§T EXCEL
        async function exportExcel() {
            try {
                const res = await fetch('/api/users', { headers: { 'Authorization': token } });
                const list = await res.json();
                if(list.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");

                // BOM ƒë·ªÉ h·ªó tr·ª£ Ti·∫øng Vi·ªát trong Excel
                let csvContent = "\uFEFFT√äN T√ÄI KHO·∫¢N,S·ªê ƒêI·ªÜN THO·∫†I,S·ªê TOKEN HI·ªÜN T·∫†I,NG√ÄY T·∫†O\n";

                list.forEach(u => {
                    const phone = u.phone || "N/A";
                    const created = new Date(u.createdAt).toLocaleDateString('vi-VN');
                    // Th√™m k√Ω t·ª± ' tr∆∞·ªõc s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ Excel hi·ªÉu l√† chu·ªói (gi·ªØ s·ªë 0 ƒë·∫ßu)
                    csvContent += `${u.username},'${phone},${u.tokens},${created}\n`;
                });

                const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent));
                link.setAttribute("download", "DANH_SACH_KHACH_HANG.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch(e) {
                console.error(e);
                alert("L·ªói khi xu·∫•t file!");
            }
        }

        async function importUser() {
            const u = document.getElementById('targetUser').value;
            if(!u) return alert("Nh·∫≠p t√™n User!");
            const res = await fetch('/api/import-member', {
                method:'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ username: u })
            });
            const data = await res.json();
            alert(data.message);
            if(data.status === 'success') loadData();
        }

        async function modifyToken(uid, type) {
            const amt = document.getElementById(`amt-${uid}`).value;
            if(!amt || amt <= 0) return alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");

            const myBalText = document.getElementById('myBalance').innerText.replace(/\./g,'').replace(/,/g,'');
            const myBal = parseInt(myBalText) || 0;
            
            if(type === 'add' && myBal < amt) {
                return alert("‚ùå B·∫†N KH√îNG ƒê·ª¶ H√ÄNG TRONG KHO!\nC√≤n l·∫°i: " + myBal.toLocaleString('vi-VN'));
            }

            const endpoint = (type === 'add') ? '/api/add-tokens' : '/api/revoke-tokens';
            
            try {
                const res = await fetch(endpoint, {
                    method:'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ targetUserId: uid, amount: amt })
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    alert(data.message);
                    loadData(); 
                } else {
                    alert("‚ùå L·ªói: " + data.message);
                }
            } catch(e) { alert("L·ªói k·∫øt n·ªëi server"); }
        }

        async function delUser(uid) {
            if(!confirm('X√≥a kh√°ch n√†y?')) return;
            await fetch('/api/delete-user', {
                method:'POST', headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ targetId: uid })
            });
            loadData();
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        
        loadData();
    </script>
</body>
</html>